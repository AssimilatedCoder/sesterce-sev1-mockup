#!/bin/bash

# Secure Sesterce Dashboard Management Script
# Now with backend API security

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REACT_DIR="$SCRIPT_DIR/sesterce-dashboard"
BUILD_DIR="$REACT_DIR/build"
NGINX_CONF="$SCRIPT_DIR/nginx-sesterce-dashboard.conf"
API_PID_FILE="$SCRIPT_DIR/api.pid"

# Load environment variables
if [ -f "$SCRIPT_DIR/.env" ]; then
    export $(cat "$SCRIPT_DIR/.env" | xargs)
fi

start_api() {
    echo "ðŸš€ Starting secure API server..."
    cd "$SCRIPT_DIR"
    
    if [ -f "$API_PID_FILE" ]; then
        if kill -0 $(cat "$API_PID_FILE") 2>/dev/null; then
            echo "API server already running (PID: $(cat $API_PID_FILE))"
            return 0
        else
            rm -f "$API_PID_FILE"
        fi
    fi
    
    # Start API server in background (using virtual environment)
    source "$SCRIPT_DIR/venv/bin/activate" && python calculator-api.py &
    API_PID=$!
    echo $API_PID > "$API_PID_FILE"
    
    # Wait a moment and check if it started successfully
    sleep 2
    if kill -0 $API_PID 2>/dev/null; then
        echo "âœ… Secure API server started (PID: $API_PID)"
        echo "ðŸ”’ API running on http://localhost:7778"
    else
        echo "âŒ Failed to start API server"
        rm -f "$API_PID_FILE"
        return 1
    fi
}

stop_api() {
    echo "ðŸ›‘ Stopping API server..."
    if [ -f "$API_PID_FILE" ]; then
        PID=$(cat "$API_PID_FILE")
        if kill -0 $PID 2>/dev/null; then
            kill $PID
            rm -f "$API_PID_FILE"
            echo "âœ… API server stopped"
        else
            echo "API server not running"
            rm -f "$API_PID_FILE"
        fi
    else
        echo "API server not running"
    fi
}

start_services() {
    echo "ðŸš€ Starting secure Sesterce dashboard services..."
    
    # Start API first
    start_api
    
    # Start Nginx
    if command -v nginx >/dev/null 2>&1; then
        if ! pgrep nginx > /dev/null; then
            sudo nginx -c "$NGINX_CONF"
            echo "âœ… Nginx started with secure configuration"
        else
            sudo nginx -s reload -c "$NGINX_CONF"
            echo "âœ… Nginx reloaded with secure configuration"
        fi
    else
        echo "âŒ Nginx not found. Please install nginx."
        return 1
    fi
    
    echo ""
    echo "ðŸŽ‰ Secure Sesterce Dashboard is now running!"
    echo "ðŸŒ Access: http://localhost:3025"
    echo "ðŸ”’ API: http://localhost:7778"
    echo "ðŸ›¡ï¸  Security: JWT Authentication + Server-side calculations"
    echo ""
    echo "ðŸ“Š Login with your credentials:"
    echo "   â€¢ Youssef / Sesterce2025_SECURE_v2"
    echo "   â€¢ Maciej / PathFinder2025_SECURE_v2" 
    echo "   â€¢ admin / Arno7747_SECURE_v2"
    echo ""
    echo "ðŸ” All passwords are now hashed and secure!"
}

stop_services() {
    echo "ðŸ›‘ Stopping secure dashboard services..."
    
    stop_api
    
    if pgrep nginx > /dev/null; then
        sudo nginx -s quit
        echo "âœ… Nginx stopped"
    fi
    
    echo "âœ… All services stopped"
}

case "$1" in
    start)
        start_services
        ;;
    stop)
        stop_services
        ;;
    restart)
        stop_services
        sleep 2
        start_services
        ;;
    api-start)
        start_api
        ;;
    api-stop)
        stop_api
        ;;
    status)
        echo "ðŸ“Š Service Status:"
        if [ -f "$API_PID_FILE" ] && kill -0 $(cat "$API_PID_FILE") 2>/dev/null; then
            echo "ðŸŸ¢ API Server: Running (PID: $(cat $API_PID_FILE))"
        else
            echo "ðŸ”´ API Server: Stopped"
        fi
        
        if pgrep nginx > /dev/null; then
            echo "ðŸŸ¢ Nginx: Running"
        else
            echo "ðŸ”´ Nginx: Stopped"
        fi
        ;;
    *)
        echo "Usage: $0 {start|stop|restart|api-start|api-stop|status}"
        echo ""
        echo "ðŸ”’ Secure Sesterce Dashboard Management"
        echo "   start     - Start both API and Nginx"
        echo "   stop      - Stop both services"
        echo "   restart   - Restart both services"
        echo "   api-start - Start only the API server"
        echo "   api-stop  - Stop only the API server"
        echo "   status    - Show service status"
        exit 1
        ;;
esac
